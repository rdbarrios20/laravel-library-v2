name: Library-v2 CI/CD Pipeline

on:
  push:
    branches: ["master", "develop"]

jobs:
  tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
      - name: Cache composer
      - uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
      - run: composer install --no-interaction --prefer-dist
      - run: php artisan key:generate
      - run: php artisan migrate --force
      - run: php artisan test

  deploy-develop:
    needs: tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    permissions:
      contents: read
      deployments: write
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Development Server
        uses: easingthemes/ssh-deploy@v2.1.5
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEV_SERVER_SSH_KEY }}
          ARGS: "-rltgoDzvO --delete --exclude=.git* --exclude=node_modules --exclude=vendor"
        with:
          SOURCE: "."
          REMOTE_HOST: ${{ secrets.DEV_SERVER_HOST }}
          REMOTE_USER: ${{ secrets.DEV_SERVER_USER }}
          TARGET: ${{ secrets.DEV_SERVER_PATH }}

  deploy-production:
    needs: tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    permissions:
      contents: read
      deployments: write
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Production Server
        uses: easingthemes/ssh-deploy@v2.1.5
        env:
          SSH_PRIVATE_KEY: ${{ secrets.PROD_SERVER_SSH_KEY }}
          ARGS: "-rltgoDzvO --delete --exclude=.git* --exclude=node_modules --exclude=vendor"
        with:
          SOURCE: "."
          REMOTE_HOST: ${{ secrets.PROD_SERVER_HOST }}
          REMOTE_USER: ${{ secrets.PROD_SERVER_USER }}
          TARGET: ${{ secrets.PROD_SERVER_PATH }}
      - name: Run migrations
        run: php artisan migrate --force
      - name:
